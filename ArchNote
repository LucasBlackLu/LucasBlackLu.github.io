#### 制作启动盘:
1. 去[官网](https://archlinux.org/download/)下载china tuna ISO镜像，插入U盘。
2. 用`lsblk`查看U盘信息，找到插入的U盘。
3. 将该U盘取消挂载，如`umount /dev/sda`
4. 将镜像文件写入U盘，`sudo dd if=***.iso  of=/dev/sda`

---
#### 基本系统安装:
1. 进入BIOS，选择UEFI启动
2. 禁止终端蜂鸣器: `rmmod pcspkr`
3. 确认是否为UEFI模式:`ls /sys/firmware/efi/efivars`
4. 联网: `iwctl`进入交互式，`device list`查看网卡名，比如wlan0，`station wlan0 scan`扫描网络，`station wlan0 get-networks`列出网络，`station wlan0 connect wifi-name`联网，`exit`退出，`ping bing.com`查看是否联网。
5. 校时: `timedatectl set-ntp true`，`timedatectl status`验证是否成功
6. 换源: `vim /etc/pacman.d/mirrorlist`，`Server = https://mirrors.tuna.tsinghua.edu.cn/archlinux/$repo/os/$arch # 清华大学开源软件镜像站`
7. 转换磁盘为GPT类型:`parted /dev/nvmexn1`， 输入`mktable`，然后gpt，yes，最后quit
9. `cfdisk`，先建立512MB的EFI分区，再创建大于内存60％的swap分区，最后剩余空间全部分给btrfs系统分区。
10. 格式化EFI分区:`mkfs.fat -F32 /dev/nvmexn1p1`，格式化swap分区`mkswap /dev/nvmexn1p2`，`mkfs.btrfs -L myArch /dev/nvmexn1p3`。
11. 创建btrfs子卷:，先挂载btrfs分区到/mnt:， `mount -t btrfs -o compress=zstd /dev/nvmexn1p3 /mnt`，`df -h`查看是否挂载成功，`btrfs subvolume create /mnt/@ ` 创建根目录子卷，`btrfs subvolume create /mnt/@home` 创建home子卷，`btrfs subvolume list -p /mnt`，查看挂载情况。将/mnt卸载以挂载子卷，`umount /mnt`。
12. 挂载各分区和以及子卷`mount -t btrfs -o subvol=/@,compress=zstd /dev/nvmexn1p3 /mnt`  挂载 / 目录。 `mkdir /mnt/home` ，创建 /home 目录，`mount -t btrfs -o subvol=/@home,compress=zstd /dev/nvmexn1p3 /mnt/home` ， 挂载 /home 目录。`mkdir -p /mnt/boot` # 创建 /boot 目录，`mount /dev/nvmexn1p1  /mnt/boot` # 挂载 /boot 目录。`swapon /dev/nvmexn1p2` # 挂载交换分区。`df -h`查看挂载情况，`free -h`查看交换分区挂载情况。
13. 安装基础包和基础软件: `pacstrap /mnt base base-devel linux linux-firmware btrfs-progs networkmanager neovim sudo zsh zsh-completions`。
14. 根据挂载情况生成定义磁盘分区的文件/etc/fstab，`genfstab -U /mnt > /mnt/etc/fstab`，要确保无误`cat /mnt/etc/fstab`
15.  切换到新安装的系统，`arch-chroot /mnt`
16. 设置主机名和时区，`nvim /etc/hostname`，键入主机名，如tzgml，然后`nvim /etc/hosts`，输入如下:
```shell
127.0.0.1   localhost
::1         localhost
127.0.1.1   tzgml.localdomain tzgml
```
17. 设置时区，`ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime`
18. 将系统时间同步到硬件时间，`hwclock --systohc`。
19. 设置locale，`nvim /etc/locale.gen`，去掉`en_US.UTF-8 UTF-8`和` zh_CN.UTF-8 UTF-8` 注释，然后生成locale: `locale-gen`，设置locale: `echo 'LANG=en_US.UTF-8'  > /etc/locale.conf`，在这里先不能设置中文locale。
20. ` passwd root`，为root设置密码。
21. `pacman -S amd-ucode`安装显卡微码，比如amd。
22. 安装引导程序，`pacman -S grub efibootmgr os-prober`，安装grub到efi分区，`grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=ARCH`，编辑`nvim /etc/default/grub`，`GRUB_CMDLINE_LINUX_DEFAULT`把`quiet`去掉改成`nowatchdog`，`loglevel`从3改成5。再加入一行`GRUB_DISABLE_OS_PROBER=false`引导win10。禁用子菜单`GRUB_DEFAULT_SUBMENU=y`，缩短启动时间`GRUB_TIMEOUT=2`，更改系统名称`GRUB_DISTRIBUTOR="Arch"`，最终生成grub配置文件，`grub-mkconfig -o /boot/grub/grub.cfg`
23. `exit`退出chroot环境，换到iso中。`umount -R /mnt`，卸载新分区，拔掉U盘，`reboot`重启进入arch。第一阶段安装结束。

---
#### 系统初始化

1. 重启后进入tty1，root为账户名，登录后联网: `systemctl enable --now NetworkManager`设置网络管理器开机自启，`nmcli dev wifi list `用于显示附近的 Wi-Fi ，`nmcli dev wifi connect "Wi-Fi名" password "网络密码"`联网，然后ping个地址测试。
2. `pacman -Syyu`，更新整个系统
3. 增加普通用户:`useradd -m -G wheel -s /bin/bash tzgml`，`passwd tzgml`设置密码，更改sudo设置`sudo nvim /etc/sudoers`，把`%wheel ALL=(ALL:ALL) NOPASSWD: ALL`和`%sudo ALL=(ALL) NOPASSWD: ALL`和`ALL ALL=(ALL) NOPASSWD: ALL`改成上述模样并取消注释，当然根据具体情况调整，主要是加NOPASSWD参数。然后`su tzgml`切换到普通用户。
4. 配置pacman，`sudo nvim /etc/pacman.conf`，去掉color注释开启彩色输出，然后`CleanMethod = KeepCurrent`减少缓存包保留，`ParallelDownloads = 同时下载数量`开启并行下载。最后去掉`[multilib]`那两行的注释开启32位库支持，末尾添加archlinuxcn源，最后别忘`pacman -Syyu`:
```shell
[archlinuxcn]
Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/$arch # 清华大学开源软件镜像站
```
5. 在本地信任farseerfc的key，`sudo pacman-key --lsign-key "farseerfc@archlinux.org"`，然后`sudo pacman -Syyu`，然后安装`sudo pacman -S archlinuxcn-keyring`，再`sudo pacman -Syyu`
6. 安装基础功能包如下:
```shell
sudo pacman -S sof-firmware alsa-firmware alsa-ucm-conf # 声音固件
sudo pacman -S ntfs-3g # 可识别 NTFS 格式硬盘
sudo pacman -S wqy-zenhei # 上文泉驿字体解决大多 wine 应用中文方块的问题
sudo pacman -S noto-fonts noto-fonts-cjk noto-fonts-emoji noto-fonts-extra # 谷歌开源字体及表情
sudo pacman -S yay #AUR助手
sudo pacman -S nerd-fonts-victor-mono #nerd字体zsh主体和nvim的powerline乱码
sudo pacman -S noto-fonts-emoji #解决不显示emoji的问题，如果还不显示，则fc-cache，然后reboot
yay -S  ttf-harmonyos-sans #鸿蒙字体，解决hcml乱码
```
7. 安装桌面环境，比如hyprland，如下:
```shell
git clone --depth=1 https://github.com/JaKooLit/Arch-Hyprland.git
cd Arch-Hyprland
chmod +x install.sh
./install.sh
```
或者plasma，安装`pacman -S plasma-meta plasma-workspace xdg-desktop-portal konsole dolphin ark packagekit-qt6 packagekit appstream-qt appstream `，N卡用户要装`egl-wayland`。装完桌面要`systemctl enable --now sddm`，进入sddm再进桌面。检查家目录，`Desktop Documents Downloads Music Pictures Videos`
8. 启用蓝牙`sudo systemctl enable --now bluetooth`
9. 安装AMD显卡驱动: `sudo pacman -S mesa lib32-mesa xf86-video-amdgpu vulkan-radeon lib32-vulkan-radeon`
10. 更改系统语言为中文: `sudo nvim /etc/locale.gen`，添加`zh_CN.UTF-8 UTF-8`，然后`sudo locale-gen`，然后`sudo nvim /etc/environment`，添加`LANG=zh_CN.UTF-8`。
11. `sudo nvim /etc/systemd/system.conf`，找到`DefaultTimeoutStopSec`和`DefaultTimeoutStartSec`，取消注释，值改成30s，然后`sudo systemctl daemon-reload`，改变开关机被阻碍问题。
12. `sudo nvim /etc/systemd/journald.conf`，然后`Storage=none`，之后`sudo journalctl --vacuum-size=0M && sudo journalctl --vacuum-time=0s`，`sudo rm -rf /var/log/* && sudo rm -rf /run/log/journal/*`。然后`sudo pacman -Scc  && yay -Scc`，然后`sudo paccache -rk0`。
13. 重启检查，基础系统安装完毕！

---

#### 配置代理
v2ray:
1. 安装v2ray与v2raya:`sudo pacman -S v2ray v2raya`
2. 设置开机启动并立刻执行，`sudo systemctl enable --now v2ray v2raya`
3. 打开浏览器进入127.0.0.1:2017
4. 打开机场，导出订阅，并寻找节点列表
- [ikuuuvpn免费50GB/月](https://ikuuu.pw/)
- [ecycloud10GB/月免费](https://owo.ecycloud.com/auth/register?code=kApr4ea5GB)  
- 将节点vmess链接复制到v2ray的SERVER中，点击设置，透明代理和规则端口的分流模式选择大陆白名单模式，透明代理实现方式选择tproxy，需要docker则选择redirect。防止DNS污染选择DOH。
5. 点击启动，去谷歌测试

clash:
1. `sudo pacman -S clash  clash-geoip  clash-meta clash-verge`
2.  开启系统代理，Tun模式，局域网连接和ipv6，导入配置文件或链接，点击使用，再去测试里一键测试。
3. [GLADOS机场](https://www.glados.rocks/)

#### 更换内核
1. 安装linux-xanmod-lts内核   `sudo pacman -S linux-xanmod linux-xanmod-headers`
2. 卸载linux原版内核，`sudo pacman -Rns linux linux-firmware`
3. 更新grub配置，`grub-mkconfig -o /boot/grub/grub.cfg`，这一步一定要有！否则删除旧内核后会进不了系统！如果忘了进入iso，挂载btrfs分区到/mnt，再挂载boot分区到/mnt/boot，然后`arch-chroot /mnt`，然后`grub-mkconfig -o /boot/grub/grub.cfg`，然后umount，拔掉U盘reboot。
4. `reboot`选择xanmod内核回车进入
5. 查看当前系统内核 `uname -a`


#### 配置输入法
1. 安装fcitx:
```
sudo pacman -S fcitx5-im # 输入法基础包组
sudo pacman -S fcitx5-chinese-addons # 官方中文输入引擎
sudo pacman -S fcitx5-material-color # 输入法主题
```
2. 设置环境变量:   `sudo vim /etc/environment`，写入:
```
GTK_IM_MODULE=fcitx
QT_IM_MODULE=fcitx
XMODIFIERS=@im=fcitx
SDL_IM_MODULE=fcitx
GLFW_IM_MODULE=ibus
```
3. 进入设置，点击语言和区域设置。再点击输入法，点击添加输入法添加拼音，配置拼音，勾选启用云拼音，配置云拼音，后端选择百度，把将嵌入预编辑文本的光标固定在开头那个选项去掉，启用预测，预测个数为50。
4. 之后退出来选择配置全局选项，将切换"启用/禁用输入法"的快捷键换为左shift，应用。
5. 点击右下角托盘的输入法。右键选择重新启动，之后按左shift或者右键选拼音，测试输入中文。
6. 安装nord主题美化:
```
git clone https://github.com/tonyfettes/fcitx5-nord.git
mkdir -p ~/.local/share/fcitx5/themes/
cd fcitx5-nord
cp -r Nord-Dark/ Nord-Light/ ~/.local/share/fcitx5/themes/
```
 之后进入fcitx配置界面，点击配置附加组件，配置经典用户界面，把主题换成Nord-Dark。


#### 常用软件最佳安装方式
- AUR源安装: 
  酷狗音乐，微信，QQ，VScode，edge，向日葵远程，anydesk，钉钉，腾讯会议，octopi，百度网盘，迅雷，JetBrains全家桶(含Android-Studio)，ANGRYsearch，GitKranken ，鸿蒙字体:
```
yay -S com.kugou.spark wechat-beta-bwrap linuxqq  visual-studio-code-bin microsoft-edge-beta-bin sunloginclient  anydesk-bin      
dingtalk-bin  wemeet-bin  octopi baidunetdisk-bin xunlei-bin jetbrains-toolbox angrysearch gitkraken  ttf-harmonyos-sans 
```

- cn源安装:
 网易云音乐，obsidian，yakuake，obs-studio，rustdesk，onlyoffice，libreoffice，ranger，tree，net-tools ，clash，gwget，htop systemdgenie，火焰截图，unarchiver，filelight ，timeshift ，nerd字体，powerline字体 trash-cli ， bleachbit垃圾清理  ，grub-customizer ：
```
sudo pacman -S netease-cloud-music-gtk4   obsidian  yakuake obs-studio-git  rustdesk  onlyoffice-bin  libreoffice  ranger tree   net-tools clash-geoip  clash-meta clash-verge gwget  htop  systemdgenie flameshot unarchiver filelight  timeshift nerd-fonts-victor-mono  oh-my-zsh-powerline-theme-git  trash-cli  bleachbit   grub-customizer  
```

- tmoe脚本安装: 哔哩哔哩客户端，腾讯视频，vnc，rdp。
- 官网下载包再本地安装: [todesk](https://www.todesk.com/linux.html)
- 通过eos welcome安装: Qt creator,chromium browser,Tor浏览器,firefox,telegram :
- wine或虚拟机:  企业微信，各平台开发者工具 (微信开发者工具要下载稳定版)，HBuiderX(必须用虚拟机，或wine开虚拟桌面)，千牛(web也行)。



#### 配置nvim
`cd .local/share`
`rm -rf nvim`
`cd ~`
`cd .config`
`git clone`
`nvim`
之后会自动装插件
后续键入`:Mason`装插件，输入`/`开始搜索，键入i下载，X删除，JS推荐使用vtsls



#### 美化终端:
1. 安装zsh:`sudo pacman -Sy zsh`
2. 更改默认终端:`chsh -s /usr/bin/zsh`
3. 安装oh-my-sh: `sh -c "$(curl -fsSL https://gitee.com/pocmon/ohmyzsh/raw/master/tools/install.sh)"`
4. 安装插件`git clone https://gitee.com/asddfdf/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting`          和 `git clone https://gitee.com/chenweizhen/zsh-autosuggestions.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions`
5. `nvim .zshrc`  ，之后`plugins=(git z zsh-syntax-highlighting zsh-autosuggestions)`
6. 安装字体:` sudo pacman -S oh-my-zsh-powerline-theme-git`
7. 配置zsh `nvim .zshrc`，设置随机自选主题，将ZSH_THEME_RANDOM_CANDIDATES=("ys"  "mikeh"  "jonathan" "af-magic"  "alanpeabody"   )    ，再ZSH_THEME="random"即可。
`

#### 配置wine:
- 安装与配置:
```
sudo pacman -S wine wine-mono wine_gecko
```
```
sudo wine winecfg
```
- 启动应用:`wine .exe`或右键exe文件选择`使用wine windows program loader打开`即可
- 将windows的C:\Windows\Fonts的字体文件全部复制到linux下的～/.wine/drive_c/windows/Fonts中，解决winecfg乱码问题。

#### 我的世界
安装启动器 : `sudo pacman -S hmcl`
打开会乱码，安装字体: `yay -S ttf-harmonyos-sans`
- 添加一个离线账户
- 进入设置到全局游戏设置，将启动器进入设置到全局游戏设置，将启动器可见性设置为`隐藏启动器并在游戏结束后重新打开`，自定义外观，进入下载版本列表源勾选自动选择下载源，尽量使用官方源。
- 下载游戏包，玩模组多的安装forge，光影安装Optifnie(我的电脑无法装光影)，安装。
- 启动游戏，弹出警告则选择继续启动。



dovk栏
deepin wine微信白底问题
wine中文开源字体
识别windows磁盘与文件的包

https://wiki.archlinux.org/title/Laptop/Lenovo

`cd /opt/visual-studio-code`
`sudo chmod -R 777 *`

/lib/ld-linux-x86-64.so.2 --help  
Subdirectories of glibc-hwcaps directories, in priority order:
  x86-64-v4
  x86-64-v3 (supported, searched)
  x86-64-v2 (supported, searched)
  git clone https://aur.archlinux.org/linux-xanmod.git
  cd linux-xanmod
  makepkg
  应该会报缺依赖，arch默认不包含clang那套东西的，手动pacman -S装上就好了
  export HTTP_PROXY="http://127.0.0.1:7897"
export HTTPS_PROXY="http://127.0.0.1:7897"
https://wiki.archlinux.org/title/Modprobed-db
nproc --all
你看看你的/etc/makepkg.conf
-j16

sudo btrfs filesystem defragment -r -v -czstd /
透明压缩
zram性能比swap好很多


plymouth 
sddn
grub
